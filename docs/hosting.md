# Hosting Architecture

This document describes how the Akeneo Custom App Demo is hosted using [Upsun](https://upsun.com/) and its global architecture.

## Upsun Platform Overview

[Upsun](https://upsun.com/) is a fully managed PaaS (Platform as a Service) built for applications that supports Node.js applications like our Next.js application. 
It provides a robust infrastructure with built-in services for hosting web applications.

## Application Architecture

```
┌─────────────────────┐     ┌─────────────────┐
│  Akeneo PIM System  │◄────┤ Custom App Demo │
└─────────────────────┘     └────────┬────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────┐
│               Upsun Platform                 │
│  ┌─────────────┐   ┌─────────────────────┐   │
│  │   Next.js   │◄──┤ Environment Config  │   │
│  │ Application │   └─────────────────────┘   │
│  └──────┬──────┘                             │
│         │         ┌─────────────────────┐    │
│         └────────►│     PostgreSQL      │    │
│                   └─────────────────────┘    │
└──────────────────────────────────────────────┘
```

## Upsun Configuration

### Platform.sh Configuration

The application is configured using `.upsun/config.yaml` which defines:

- Build and deploy scripts
- Web server configuration
- Cron jobs
- Resource allocation
- Environment variables

### Services Configuration

Services like PostgreSQL are defined in `.upsun/config.yaml`:

```yaml
services:
  postgresql:
    type: postgresql:15
```

### Routes Configuration

Routes are defined in `.upsun/config.yaml` to manage how traffic is directed to the application.

## Environment Variables

The application uses environment variables for configuration, which are set in the Upsun console:

- `AKENEO_CLIENT_ID`: Client ID for Akeneo API integration
- `AKENEO_CLIENT_SECRET`: Client secret for Akeneo API
- `DATABASE_URL`: Connection string for PostgreSQL
- Additional environment-specific variables

App variables like `AKENEO_CLIENT_ID` and `AKENEO_CLIENT_SECRET` are set in the Upsun console for secure access.

Internal system variables like `DATABASE_URL` are automatically generated by Upsun and should not be modified.
These variables are set up into `.environment` file in order to extract and export the variables we need according to the environment we are in.

## Deployment Process

1. Code is pushed to a Git repository
2. Upsun automatically detects changes and starts the build process
3. Dependencies are installed via `npm install`
4. Next.js application is built
5. Database migrations are applied
6. New deployment is created and traffic is switched over

## Database Management

PostgreSQL database is:
- Automatically provisioned by Upsun
- Backed up regularly
- Accessible via Upsun CLI for maintenance
- Used to store app data including Akeneo authentication tokens

## Multi-Environment Support

Upsun provides:
- Production environment
- Staging environment
- Development environments for feature branches
- Each environment has its own isolated database and services

## Scaling

The application scales through:
- Horizontal scaling (multiple instances)
- Vertical scaling (increased resources)
- Managed by Upsun based on defined resources in configuration

## Monitoring and Maintenance

- Upsun provides built-in monitoring tools
- Application logs accessible via Upsun CLI
- Metrics dashboard for resource usage
- Automated maintenance and security updates

## Integration with Akeneo PIM

The hosted application connects to Akeneo PIM through:
- OAuth authentication
- Webhooks for real-time events
- API calls for data synchronization
- UI extensions loaded directly in the Akeneo interface
